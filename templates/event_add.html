<!DOCTYPE html>
<title>{{@appname}} :: Add an event</title>

<F3:include href="_stylesheets.html" />
<link rel="stylesheet" type="text/css" href="{{@baseurl}}/css/jquery.timepicker.css">
<link rel="stylesheet" type="text/css" href="{{@baseurl}}/css/jquery-ui-1.8.24.custom.css">

<body class="thin">
<F3:include href="_header.html" />

<section id="event_add">
<h2>Add an event</h2>

<F3:check if="{{isset(@messages)}}">
<ul>
<F3:repeat group="{{@messages}}" value="{{@message}}">
	<li>{{@message}}
</F3:repeat>
</ul>
</F3:check>

<form method="POST" action="?">

<fieldset>
<label class="left" for="title">Event name:</label>
<input class="right required" type="text" name="title" id="title" {{isset(@title)?@value(@title):NULL}}>

<div class="right">
<input type="checkbox" id="film" name="film" {{isset(@film)&&@film?'checked':''}}>
<label for="film">This is a film showing</label>
</div>
</fieldset>

<fieldset>
<label class="left" for="date">Time and date:</label>
<div class="right" id="start">
Starts <input class="required time" type="text" name="time1" id="time1" {{isset(@time1)?@value(@time1):NULL}} placeholder="time"> on <input class="required" type="text" id="date1" name="date1" placeholder="date" {{isset(@date1)?@value(@date1):NULL}}><br>
</div>
<div class="right" id="end" style="display: none;">
Ends <input class="required time" type="text" name="time2" id="time2" {{isset(@time2)?@value(@time2):NULL}} placeholder="time"> on <input class="required date" type="text" id="date2" name="date2" placeholder="date" {{isset(@date2)?@value(@date2):NULL}}>
</div>
<div class="right">
<input type="checkbox" id="set_end"> <label for="set_end">Set an end time and date?</label>
</div>
</fieldset>

<fieldset>
<div class="left">
<label for="location">Location:</label>
<p class="desc" style="margin-top: 10px">Or select from below:</p>
</div>
<input class="right required" type="text" name="location" id="location" autocomplete="off" {{isset(@location)?@value(@location):NULL}}>
</fieldset>

<div id="venues" style="display: none;">
<ul id="vlist"></ul>
</div>
</fieldset>

<fieldset>
<label class="left">Price:</label>

<div class="right">
<input type="radio" name="free" id="free" {{isset(@free)&&@free?'checked':''}} value="free"> <label for="free">Free</label><br>
<input type="radio" name="free" id="costbutton" {{isset(@cost)&&@cost?'checked':''}}> <label for="costbutton">It costs</label> <input type="text" name="cost" id="cost" style="width: 220px;" {{isset(@cost)?@value(@cost):NULL}}>
</div>
</fieldset>

<fieldset>
<div class="left">
<label for="blurb">Please describe your event:</label>
<p class="desc">Please include the group organising the event and information about booking if you have to book.  Maximum 120 words.</p>
</div>

<textarea class="right required" name="blurb" id="blurb" rows="8">{{isset(@blurb)?@blurb:NULL}}</textarea>
<p class="right count" style="display: none;"><i>Word count:</i> <span id="wordcount">0</span> / 120</p>
</fieldset>

<fieldset>
<div class="left">
<label for="url">URL for more info:</label>
<p class="desc">Is there somewhere on the web people can go to get more information, like a blog post / Facebook event?</p>
</div>

<input class="right permissive_url" type="text" name="url" id="url" {{isset(@url)?@value(@url):NULL}}>
</fieldset>

<fieldset>
<label class="left" for="email">Your email:</label>
<input class="right required email" type="text" name="email" id="email" {{isset(@email)?@value(@email):NULL}}>
</fieldset>

<input type="submit" value="Submit your event!">
</form>
</section>

<F3:include href="_footer.html" />

<script src="//ajax.aspnetcdn.com/ajax/jquery.validate/1.11.1/jquery.validate.js"></script>
<script src="{{@baseurl}}/js/venuelist.js"></script>
<script src="{{@baseurl}}/js/jquery-ui-1.10.2.custom.min.js"></script>
<script src="{{@baseurl}}/js/jquery.timepicker.min.js"></script>

<script>
$(function() {

// Word count function (not great but accurate enough)
function word_count(s) {
	if (s == "") return 0;
	return (s.match(/ +/g) || []).length + 1
}

// Initialise jQueryUI widgets
function initWidgets() {
	var time_options = { step: 30, timeFormat: 'H:i' };
	var date_options = {
		dateFormat: "DD d MM",
		firstDay: 1,
		minDate: 1,
		maxDate: "+3M",
		numberOfMonths: 12,
	};

	// Start time & date
	$("#time1").timepicker(time_options);
	$("#time2").timepicker(time_options);
	$("#date1").datepicker(date_options);
	$("#date2").datepicker(date_options);
}

// Initialise venue list
function initVenues() {
	var mylist = [
	<F3:repeat group="{{@get_venues()}}" value="{{@venue}}">
		"{{@venue.name}}",
	</F3:repeat>
	];

	venuelist.init(mylist, "#vlist", "#location");
	venuelist.empty = function(empty) {
		if (empty)
			$("#venues").addClass("empty");
		else
			$("#venues").removeClass("empty");	
	};

	$("#venues").show();
}

// Initialise form validation
function initFormValidation() {

	$.validator.addMethod("wordcount", function(value, element, params) {
		return word_count($(element).val()) <= 120
	}, "Your blurb is over the word limit.");

	$.validator.addMethod("permissive_url", function(value, element) {
		// if no url, don't do anything
		if (value.length == 0) return true;

		// if user has not entered http[s]:// or ftp:// assume they mean http://
		if (!/^(https?|ftp)\:\/\//i.test(value))
			value = 'http://' + value;

		// Chain to the builtin URL validator
		return $.validator.methods.url.call(this, value, element);
	}, "The link is not valid.  Please provide a valid one.");

	$("form").validate({
		errorPlacement: function(error, element) {
			if (element.attr("name") == "time1" ||
					element.attr("name") == "date1" ||
					element.attr("name") == "time2" ||
					element.attr("name") == "date2")
				error.insertAfter(element.parent());
			else
				error.insertAfter(element);
		},
		messages: {
			title: "You must provide a title.",
			location: "You must provide a location.",
			blurb: "You must provide a blurb.",
			time1: "You must provide a time.",
			date1: "You must provide a date.",
			time2: "You must provide a time.",
			date2: "You must provide a date.",
			email: {
				required: "You must provide an email",
				email: "This email address is not valid.  Please use a valid address."
			}
		},
		rules: {
			// All other rules are done using classes on the inputs themselves
			cost: {		
				required: {
					depends: function(element) {
						return $("#costbutton:checked").length != 0
					}
				}
			},
			blurb: {
				wordcount: 120
			}
		}
	});
}

function initWordCount() {
	$(".count").show();
	$("#blurb").on("input", function(e) {
		var wc = word_count($(e.target).val());
		$("#wordcount").text(wc);
		if (wc > 120)
			$("#wordcount").addClass("overcount");
		else
			$("#wordcount").removeClass("overcount");
	})
}

function initEndDatetime() {
	var end_panel = $("#end");
	var time2 = $("#time2");
	var date2 = $("#date2");
	var update_panel = function() {
		if ($("#set_end").prop('checked')) {
			// Use a default value if showing
			if (!date2.val() || date2.val() == "")
				date2.val($("#date1").val());

			time2.prop('disabled', false);
			date2.prop('disabled', false);
			end_panel.show();
		} else {
			time2.prop('disabled', true);
			date2.prop('disabled', true);
			end_panel.hide();
		}
	};

	$("#set_end").change(update_panel);
	if (time2.val() || date2.val()) {
		$("#set_end").prop('checked', true);
	}
	update_panel();
}

function initFilmIcon() {
	$("#film").click(function(e) {
		if (e.target.checked)
			$("#title").addClass("film");
		else
			$("#title").removeClass("film");
	});
}

function initCostLogic() {
	function update_disabled() {
		if ($("#free").prop('checked') == true) {
			$("#cost").prop('disabled', true);
			$("#cost").valid();
		} else {
			$("#cost").prop('disabled', false);
		}
	};

	update_disabled();
	$("#free").change(update_disabled);
	$("#costbutton").change(update_disabled);

	// Set up an initial value
	if ($('input[name="free"]:checked').length == 0) {
		$("#free").prop('checked', true);
	}
}

initWidgets();
initVenues();
initFormValidation();
initWordCount();
initEndDatetime();
initFilmIcon();
initCostLogic();

});
</script>
