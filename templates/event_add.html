<!DOCTYPE html>
<title>{{@appname}} :: Add an event</title>

<F3:include href="_stylesheets.html" />
<link rel="stylesheet" type="text/css" href="{{@baseurl}}/css/editform.css">
<link rel="stylesheet" type="text/css" href="{{@baseurl}}/css/jquery.timepicker.css">
<link rel="stylesheet" type="text/css" href="{{@baseurl}}/css/jquery-ui-1.8.24.custom.css">

<script src="//ajax.googleapis.com/ajax/libs/jquery/1.8.2/jquery.min.js"></script>
<script src="//ajax.aspnetcdn.com/ajax/jquery.validate/1.11.0/jquery.validate.min.js"></script>
<script src="{{@baseurl}}/js/jquery-ui-1.8.24.custom.min.js"></script>
<script src="{{@baseurl}}/js/jquery.timepicker.min.js"></script>
<script src="{{@baseurl}}/js/venuelist.js"></script>

<script>
$(function() {

// Datepicker
$("#date").hide();
$("#datepicker").datepicker({
	dateFormat: "yy-mm-dd",
	firstDay: 1,
	onSelect: function(dt, inst) { $("#date").val(dt); },
	minDate: 1,
	maxDate: "+2M"
});

// Timepicker
$("#time").timepicker({ step: 15, timeFormat: 'H:i' });

// Film/free functionality
$("#film").click(function(e) {
	if (e.target.checked)
		$("#title").addClass("film");
	else
		$("#title").removeClass("film");
});

var update_disabled = function() {
	if ($("#free").attr('checked') == "checked")
		$("#cost").attr('disabled', 'disabled');
	else
		$("#cost").removeAttr('disabled');
};

update_disabled();
$("#free").change(update_disabled);
$("#costbutton").change(update_disabled);

// Set up an initial value
if ($('input[name="free"]:checked').length == 0) {
	$("#free").attr('checked', 'checked');
}

// Venuelist
var mylist = [
<F3:repeat group="{{@get_venues()}}" value="{{@venue}}">
	"{{@venue.name}}",
</F3:repeat>
];

venuelist.init(mylist, "#vlist", "#location");
venuelist.empty = function(empty) {
	if (empty)
		$("#venues").addClass("empty");
	else
		$("#venues").removeClass("empty");	
};

$("#venues").show();

// Cool word count thing
function word_count(s) {
	if (s == "") return 0;
	return (s.match(/ +/g) || []).length + 1
}

$(".count").show();
$("#blurb").on("input", function(e) {
	var wc = word_count($(e.target).val());
	if (wc > 250)
		$("#wordcount").addClass("overcount");
	else
		$("#wordcount").removeClass("overcount");
	$("#wordcount").text(wc);
})

// validation
$("form").validate({
	messages: {
		title: {
			required: "You must provide a title.",
			minlength: "Please use a longer title."
		},
		location: {
			required: "You must provide a location.",
		},
		blurb: {
			required: "You must provide a blurb.",
		},
		time: {
			required: "You must provide a time.",
		},
		date: {
			required: "You must provide a date.",
		},
		email: {
			required: "You must provide an email",
			email: "This email address is not valid.  Please use a valid address."
		}
	},
});

$.validator.addMethod("wordcount", function(value, element, params) {
	return word_count($(element).val()) <= 250
}, "Your blurb is over the word limit.");

$.validator.addMethod("permissive_url", function(value, element) {
	// if no url, don't do anything
	if (value.length == 0) return true;

	// if user has not entered http[s]:// or ftp:// assume they mean http://
	if (!/^(https?|ftp):\/\//i.test(value))
		value = 'http://' + value;

//	return $.validator.methods.url(val, element);
	return /^(https?|s?ftp):\/\/(((([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(%[\da-f]{2})|[!\$&'\(\)\*\+,;=]|:)*@)?(((\d|[1-9]\d|1\d\d|2[0-4]\d|25[0-5])\.(\d|[1-9]\d|1\d\d|2[0-4]\d|25[0-5])\.(\d|[1-9]\d|1\d\d|2[0-4]\d|25[0-5])\.(\d|[1-9]\d|1\d\d|2[0-4]\d|25[0-5]))|((([a-z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(([a-z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])*([a-z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])))\.)+(([a-z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(([a-z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])*([a-z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])))\.?)(:\d*)?)(\/((([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(%[\da-f]{2})|[!\$&'\(\)\*\+,;=]|:|@)+(\/(([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(%[\da-f]{2})|[!\$&'\(\)\*\+,;=]|:|@)*)*)?)?(\?((([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(%[\da-f]{2})|[!\$&'\(\)\*\+,;=]|:|@)|[\uE000-\uF8FF]|\/|\?)*)?(#((([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(%[\da-f]{2})|[!\$&'\(\)\*\+,;=]|:|@)|\/|\?)*)?$/i.test(value);
}, "The link is not valid.  Please provide a valid one.");

$("#title").rules("add", { minlength: 3 });
$("#date").rules("add", { dateISO: true });
$("#blurb").rules("add", { wordcount: 250 });
$("#url").rules("add", { permissive_url: true });
$("#email").rules("add", { email: true });

});
</script>

<body class="thin">
<F3:include href="_header.html" />

<section id="add">
<h2>Add an event</h2>

<F3:check if="{{count(@messages)}}">
<ul>
<F3:repeat group="{{@messages}}" value="{{@message}}">
	<li>{{@message}}
</F3:repeat>
</ul>
</F3:check>

<form method="POST" action="?">

<fieldset>
<label class="left" for="title">Event name:</label>
<input class="right required" type="text" name="title" id="title" {{@value(@title)}}>

<div class="right">
<input type="checkbox" id="film" name="film" {{@film?'checked':''}}>
<label for="film">This is a film showing</label>
</div>
</fieldset>

<fieldset>
<label class="left" for="location">Location:</label>
<input class="right required" type="text" name="location" id="location" autocomplete="off" {{@value(@location)}}>
</fieldset>

<div id="venues" style="display: none;">Or select from below:
<ul id="vlist"></ul>
</div>
</fieldset>

<fieldset>
<label class="left" for="date">Time and date:</label>
<input class="right required" type="text" name="time" id="time" {{@value(@time)}} placeholder="Time (hh:mm)"><br>
<input class="right required" type="text" name="date" id="date" {{@value(@date)}} placeholder="Date (yyyy-mm-dd)">
<div class="right" id="datepicker"></div>
</fieldset>

<fieldset>
<label class="left">Price:</label>

<div class="right">
<input type="radio" name="free" id="free" {{@free?'checked':''}} value="free"> <label for="free">Free</label><br>
<input type="radio" name="free" id="costbutton" {{@cost?'checked':''}}> <label for="costbutton">It costs</label> <input type="text" name="cost" id="cost" style="width: 220px;" {{@value(@cost)}}>
</div>
</fieldset>

<fieldset>
<div class="left">
<label for="blurb">Please describe your event:</label>
<p class="desc">Please include the group organising the event and information about booking if you have to book.  Maximum 250 words.</p>
</div>

<textarea class="right required" name="blurb" id="blurb" rows="8">{{@blurb}}</textarea>
<p class="right count" style="display: none;"><i>Word count:</i> <span id="wordcount">0</span> / 250</p>
</fieldset>

<fieldset>
<div class="left">
<label for="url">URL for more info:</label>
<p class="desc">Is there somewhere on the web people can go to get more information, like a blog post / Facebook event?</p>
</div>

<input class="right" type="text" name="url" id="url" {{@value(@url)}}>
</fieldset>

<fieldset>
<label class="left" for="email">Your email:</label>
<input class="right required" type="text" name="email" id="email" {{@value(@email)}}>
</fieldset>

<input type="submit" value="Submit your event!">
</form>
</section>

<F3:include href="_footer.html" />
